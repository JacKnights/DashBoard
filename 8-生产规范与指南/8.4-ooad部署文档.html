<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>EasyOrder | ooad部署文档</title>
    <meta name="description" content="DashBoard">
    
    
    <link rel="preload" href="/DashBoard/assets/css/56.styles.500ee7d6.css" as="style"><link rel="preload" href="/DashBoard/assets/js/app.375a5640.js" as="script"><link rel="preload" href="/DashBoard/assets/js/14.19f2640e.js" as="script"><link rel="prefetch" href="/DashBoard/assets/js/1.815d076e.js"><link rel="prefetch" href="/DashBoard/assets/js/0.fc47b4cd.js"><link rel="prefetch" href="/DashBoard/assets/js/2.8a1c31ae.js"><link rel="prefetch" href="/DashBoard/assets/js/3.fb8a6b2e.js"><link rel="prefetch" href="/DashBoard/assets/js/4.49b43a79.js"><link rel="prefetch" href="/DashBoard/assets/js/5.d50f8be1.js"><link rel="prefetch" href="/DashBoard/assets/js/6.8b5b7547.js"><link rel="prefetch" href="/DashBoard/assets/js/7.49ceb857.js"><link rel="prefetch" href="/DashBoard/assets/js/8.b5223fec.js"><link rel="prefetch" href="/DashBoard/assets/js/9.515fb130.js"><link rel="prefetch" href="/DashBoard/assets/js/10.7aa2362b.js"><link rel="prefetch" href="/DashBoard/assets/js/11.301a4780.js"><link rel="prefetch" href="/DashBoard/assets/js/12.54f44ffe.js"><link rel="prefetch" href="/DashBoard/assets/js/13.bf54bf21.js"><link rel="prefetch" href="/DashBoard/assets/js/15.84f54907.js"><link rel="prefetch" href="/DashBoard/assets/js/16.7152cef1.js"><link rel="prefetch" href="/DashBoard/assets/js/17.45264804.js"><link rel="prefetch" href="/DashBoard/assets/js/18.3f88abd3.js"><link rel="prefetch" href="/DashBoard/assets/js/19.399c13a6.js"><link rel="prefetch" href="/DashBoard/assets/js/20.a9bb35ac.js"><link rel="prefetch" href="/DashBoard/assets/js/21.8a2830a9.js"><link rel="prefetch" href="/DashBoard/assets/js/22.3ab047b0.js"><link rel="prefetch" href="/DashBoard/assets/js/23.1927407e.js"><link rel="prefetch" href="/DashBoard/assets/js/24.ece0962a.js"><link rel="prefetch" href="/DashBoard/assets/js/25.de82bea7.js"><link rel="prefetch" href="/DashBoard/assets/js/26.af5405ff.js"><link rel="prefetch" href="/DashBoard/assets/js/27.137a5779.js"><link rel="prefetch" href="/DashBoard/assets/js/28.6ba32fde.js"><link rel="prefetch" href="/DashBoard/assets/js/29.37dca81b.js"><link rel="prefetch" href="/DashBoard/assets/js/30.faf971a3.js"><link rel="prefetch" href="/DashBoard/assets/js/31.20284640.js"><link rel="prefetch" href="/DashBoard/assets/js/32.effb84d0.js"><link rel="prefetch" href="/DashBoard/assets/js/33.63c939d0.js"><link rel="prefetch" href="/DashBoard/assets/js/34.409d93f8.js"><link rel="prefetch" href="/DashBoard/assets/js/35.a9fdc604.js"><link rel="prefetch" href="/DashBoard/assets/js/36.26076c3c.js"><link rel="prefetch" href="/DashBoard/assets/js/37.4ef3ce41.js"><link rel="prefetch" href="/DashBoard/assets/js/38.5af51780.js"><link rel="prefetch" href="/DashBoard/assets/js/39.875be6be.js"><link rel="prefetch" href="/DashBoard/assets/js/40.2325c3cc.js"><link rel="prefetch" href="/DashBoard/assets/js/41.034fe344.js"><link rel="prefetch" href="/DashBoard/assets/js/42.24a5121d.js"><link rel="prefetch" href="/DashBoard/assets/js/43.ef1fb67c.js"><link rel="prefetch" href="/DashBoard/assets/js/44.367c9ef6.js"><link rel="prefetch" href="/DashBoard/assets/js/45.74a9a887.js"><link rel="prefetch" href="/DashBoard/assets/js/46.7aa6db16.js"><link rel="prefetch" href="/DashBoard/assets/js/47.3b607220.js"><link rel="prefetch" href="/DashBoard/assets/js/48.52f6afc8.js"><link rel="prefetch" href="/DashBoard/assets/js/49.2a856fae.js"><link rel="prefetch" href="/DashBoard/assets/js/50.63e871d0.js"><link rel="prefetch" href="/DashBoard/assets/js/51.93ca4349.js"><link rel="prefetch" href="/DashBoard/assets/js/52.380aec7e.js"><link rel="prefetch" href="/DashBoard/assets/js/53.9d6f4050.js"><link rel="prefetch" href="/DashBoard/assets/js/54.cd5b57ab.js"><link rel="prefetch" href="/DashBoard/assets/js/55.7dff6ce7.js">
    <link rel="stylesheet" href="/DashBoard/assets/css/56.styles.500ee7d6.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div><a href="/DashBoard/" class="home-link router-link-active"><!----><span class="site-name">
      EasyOrder
    </span></a><div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""><!----></div><nav class="nav-links can-hide"><div class="nav-item"><a href="/DashBoard/X3_Final_report.html" class="nav-link">期末总结</a></div><div class="nav-item"><a href="/DashBoard/2-Team_profile.html" class="nav-link">团队组员</a></div><div class="nav-item"><a href="/DashBoard/7-Design/7.3-API设计/" class="nav-link">API</a></div><div class="nav-item"><a href="https://github.com/OOAD-Project" target="_blank" rel="noopener noreferrer" class="nav-link">Github</a></div><!----></nav></div></header><div class="sidebar-mask"></div><div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/DashBoard/X3_Final_report.html" class="nav-link">期末总结</a></div><div class="nav-item"><a href="/DashBoard/2-Team_profile.html" class="nav-link">团队组员</a></div><div class="nav-item"><a href="/DashBoard/7-Design/7.3-API设计/" class="nav-link">API</a></div><div class="nav-item"><a href="https://github.com/OOAD-Project" target="_blank" rel="noopener noreferrer" class="nav-link">Github</a></div><!----></nav><!----></div><div class="page"><div class="content"><h1 id="ooad部署文档"><a href="#ooad部署文档" aria-hidden="true" class="header-anchor">#</a> ooad部署文档</h1><p>标签： 系统分析与设计</p><hr><p>郭柱明 15331094</p><hr><h2 id="框架和依赖"><a href="#框架和依赖" aria-hidden="true" class="header-anchor">#</a> 框架和依赖</h2><p>使用语言是python 版本为<strong>python3.6+</strong></p><p>web后端框架 异步框架<strong>aiohttp</strong>
版本
<img src="http://static.zybuluo.com/gzm1997/aqgxm1xey0avv6dulwvlkyb7/image_1ch5t4tip1bu65fi1iin1up1r789.png" alt="image_1ch5t4tip1bu65fi1iin1up1r789.png-4.4kB"></p><p>其他第三方依赖以及版本</p><p>aiohttp_session
<img src="http://static.zybuluo.com/gzm1997/ecw0ctjio6gzlo12zn7f14sr/image_1ch5t9r2rmg1esaqge1f6i1semm.png" alt="image_1ch5t9r2rmg1esaqge1f6i1semm.png-6.5kB"></p><p>aiohttp_cors
<img src="http://static.zybuluo.com/gzm1997/yvz876uk43ihswa50bqzdpcx/image_1ch5tlboen2h3sj1v4f1qh71kla13.png" alt="image_1ch5tlboen2h3sj1v4f1qh71kla13.png-6.8kB">
aioredis
<img src="http://static.zybuluo.com/gzm1997/31v4ugt1lpppufznyhd8jjh4/image_1ch5tloe510ma1iic7ohdnl1qhv1g.png" alt="image_1ch5tloe510ma1iic7ohdnl1qhv1g.png-5.8kB">
passlib
<img src="http://static.zybuluo.com/gzm1997/4754pchsze7z8efy6n76tu1s/image_1ch5tm4nq144lq9b6i1amt1o1f1t.png" alt="image_1ch5tm4nq144lq9b6i1amt1o1f1t.png-5.9kB">
pyyaml
<img src="http://static.zybuluo.com/gzm1997/pip2tju6mzgdvtt6x90kfmpx/image_1ch5tmki2lude8n1qg9n001i322a.png" alt="image_1ch5tmki2lude8n1qg9n001i322a.png-5.9kB">
aiomysql
<img src="http://static.zybuluo.com/gzm1997/ixexz65anin6x3za5seg1es3/image_1ch5tni4r1h4u60c1kpvj0t1n4j2n.png" alt="image_1ch5tni4r1h4u60c1kpvj0t1n4j2n.png-6.5kB">
mysql.connector
<img src="http://static.zybuluo.com/gzm1997/dh4590ia4lwrvc1gr6dttk4l/image_1ch5tnvds1fcf1okrepeg0sh2g34.png" alt="image_1ch5tnvds1fcf1okrepeg0sh2g34.png-7.3kB">
sqlalchemy
<img src="http://static.zybuluo.com/gzm1997/eeoo5hblwzyutl1hnah4uejz/image_1ch5tpbhve7sq7019iqufkj4r5h.png" alt="image_1ch5tpbhve7sq7019iqufkj4r5h.png-4.8kB"></p><p>数据库使用mysql
<img src="http://static.zybuluo.com/gzm1997/w6vk425amvol1q90661l03jh/image_1ch5tv4tt7a91ela1vs7bu92op9.png" alt="image_1ch5tv4tt7a91ela1vs7bu92op9.png-924.3kB"></p><hr><h2 id="部署"><a href="#部署" aria-hidden="true" class="header-anchor">#</a> 部署</h2><p>为什么选择nginx+supervisor这样的组合来部署 因为</p><p>优点</p><ul><li>nginx是一个完美的前端服务器 可以防止基于畸形的http协议的攻击等等</li><li>使用nginx运行几个aiohttp实例可以使用CPU多核</li><li>nginx对static静态文件的支持比aiohttp的内置的静态文件支持更快</li><li>supervisor主要是为了系统崩溃或者重启之后重新运行web app实例 怎么kill也kill不掉</li></ul><p>缺点</p><ul><li>配置比其他组合方式麻烦一点</li></ul><p><a href="http://static.zybuluo.com/gzm1997/aqgxm1xey0avv6dulwvlkyb7/image_1ch5t4tip1bu65fi1iin1up1r789.png" target="_blank" rel="noopener noreferrer">参考链接</a></p><p>由于选择使用nginx+superviosr的组合方式部署aiohttp 所以要先下载nginx和supervisor 这个没什么问题 自行谷歌即可 但是要注意点</p><blockquote><p>因为aiohttp是只可以支持python3.5.3+的 但是好巧不巧ubuntu16.04的自带python版本是python3.5.2 这下有点蛋疼 我给的建议是保留python3.5 另外安装python3.6</p><p>因为ubuntu系统以及很多像sublime等软件都是依赖py2或者py3.5的 一旦卸载或者修改了/use/bin/python的链接
会导致一系列版本不兼容的问题 我试过最严重的是卸载了python3.5 并且修改默认python版本为3.6 系统崩溃
折腾了很久最后只能重装系统</p><p>为什么我要说这个呢 因为supervisor依赖于ubuntu的py2的
所以最好不要卸载任何版本python和修改系统默认的python版本 最好就另行安装python3.6 终端中使用python3.6调用即可</p></blockquote><p>项目代码放置于/var/www/aio_ooad下
<img src="http://static.zybuluo.com/gzm1997/ecw0ctjio6gzlo12zn7f14sr/image_1ch5t9r2rmg1esaqge1f6i1semm.png" alt="image_1cff1giub10gmo07k6b16gjv339.png-71.6kB"></p><hr><h2 id="nginx配置"><a href="#nginx配置" aria-hidden="true" class="header-anchor">#</a> nginx配置</h2><ul><li>nginx配置文件 /etc/nginx/nginx.conf</li><li>nginx日志文件</li><li>/var/log/nginx/access.log</li><li>/var/log/nginx/error.log</li></ul><p>/etc/nginx/nginx.conf</p><pre class="language-java"><code>http <span class="token punctuation">{</span>
  server <span class="token punctuation">{</span>
    listen <span class="token number">80</span><span class="token punctuation">;</span>
    client_max_body_size <span class="token number">4</span>G<span class="token punctuation">;</span>

    server_name localhost<span class="token punctuation">;</span>

    location <span class="token operator">/</span> <span class="token punctuation">{</span>
      proxy_set_header Host $http_host<span class="token punctuation">;</span>
      proxy_set_header X<span class="token operator">-</span>Forwarded<span class="token operator">-</span>For $proxy_add_x_forwarded_for<span class="token punctuation">;</span>
      proxy_redirect off<span class="token punctuation">;</span>
      proxy_buffering off<span class="token punctuation">;</span>
      proxy_pass http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>aiohttp<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    location <span class="token operator">/</span><span class="token keyword">static</span> <span class="token punctuation">{</span>
      # path <span class="token keyword">for</span> <span class="token keyword">static</span> files
      root <span class="token operator">/</span>var<span class="token operator">/</span>www<span class="token operator">/</span>aio_ooad<span class="token operator">/</span><span class="token keyword">static</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

  <span class="token punctuation">}</span>
  upstream aiohttp <span class="token punctuation">{</span>
    # fail_timeout<span class="token operator">=</span><span class="token number">0</span> means we always retry an upstream even <span class="token keyword">if</span> it failed
    # to <span class="token keyword">return</span> a good HTTP response

    # Unix domain servers
    server unix<span class="token operator">:</span><span class="token operator">/</span>var<span class="token operator">/</span>www<span class="token operator">/</span>aio_ooad<span class="token operator">/</span>example_1<span class="token punctuation">.</span>sock fail_timeout<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
    server unix<span class="token operator">:</span><span class="token operator">/</span>var<span class="token operator">/</span>www<span class="token operator">/</span>aio_ooad<span class="token operator">/</span>example_2<span class="token punctuation">.</span>sock fail_timeout<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
    server unix<span class="token operator">:</span><span class="token operator">/</span>var<span class="token operator">/</span>www<span class="token operator">/</span>aio_ooad<span class="token operator">/</span>example_3<span class="token punctuation">.</span>sock fail_timeout<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
    server unix<span class="token operator">:</span><span class="token operator">/</span>var<span class="token operator">/</span>www<span class="token operator">/</span>aio_ooad<span class="token operator">/</span>example_4<span class="token punctuation">.</span>sock fail_timeout<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>

    # Unix domain sockets are used in <span class="token keyword">this</span> example due to their high performance<span class="token punctuation">,</span>
    # but TCP<span class="token operator">/</span>IP sockets could be used instead<span class="token operator">:</span>
    # server <span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token operator">:</span><span class="token number">8081</span> fail_timeout<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
    # server <span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token operator">:</span><span class="token number">8082</span> fail_timeout<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
    # server <span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token operator">:</span><span class="token number">8083</span> fail_timeout<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
    # server <span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token operator">:</span><span class="token number">8084</span> fail_timeout<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p>上面大部分内容都是常规的</p><p>指明静态文件路径 nginx提供静态文件的支持是很快的 这是选择nginx部署的原因之一</p><pre class="language-java"><code>    location <span class="token operator">/</span><span class="token keyword">static</span> <span class="token punctuation">{</span>
      # path <span class="token keyword">for</span> <span class="token keyword">static</span> files
      root <span class="token operator">/</span>var<span class="token operator">/</span>www<span class="token operator">/</span>aio_ooad<span class="token operator">/</span><span class="token keyword">static</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><p>选择使用unix domian sockets文件的方式设置upstream 下面的注释也说到也可以使用TCP/IP sockets的方式 但是unix domain socket效果更好 一共配置了四个sockets文件 意味着后台一共有四个web app实例可以供nginx轮询选择</p><pre class="language-java"><code>  upstream aiohttp <span class="token punctuation">{</span>
    # fail_timeout<span class="token operator">=</span><span class="token number">0</span> means we always retry an upstream even <span class="token keyword">if</span> it failed
    # to <span class="token keyword">return</span> a good HTTP response

    # Unix domain servers
    server unix<span class="token operator">:</span><span class="token operator">/</span>var<span class="token operator">/</span>www<span class="token operator">/</span>aio_ooad<span class="token operator">/</span>example_1<span class="token punctuation">.</span>sock fail_timeout<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
    server unix<span class="token operator">:</span><span class="token operator">/</span>var<span class="token operator">/</span>www<span class="token operator">/</span>aio_ooad<span class="token operator">/</span>example_2<span class="token punctuation">.</span>sock fail_timeout<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
    server unix<span class="token operator">:</span><span class="token operator">/</span>var<span class="token operator">/</span>www<span class="token operator">/</span>aio_ooad<span class="token operator">/</span>example_3<span class="token punctuation">.</span>sock fail_timeout<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
    server unix<span class="token operator">:</span><span class="token operator">/</span>var<span class="token operator">/</span>www<span class="token operator">/</span>aio_ooad<span class="token operator">/</span>example_4<span class="token punctuation">.</span>sock fail_timeout<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>

    # Unix domain sockets are used in <span class="token keyword">this</span> example due to their high performance<span class="token punctuation">,</span>
    # but TCP<span class="token operator">/</span>IP sockets could be used instead<span class="token operator">:</span>
    # server <span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token operator">:</span><span class="token number">8081</span> fail_timeout<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
    # server <span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token operator">:</span><span class="token number">8082</span> fail_timeout<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
    # server <span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token operator">:</span><span class="token number">8083</span> fail_timeout<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
    # server <span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token operator">:</span><span class="token number">8084</span> fail_timeout<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre><hr><h2 id="supervisor配置"><a href="#supervisor配置" aria-hidden="true" class="header-anchor">#</a> supervisor配置</h2><ul><li>supervisor默认配置文件 /etc/supervisor/supervisord.conf</li><li>部署项目的配置文件 /etc/supervisor/conf.d/example.ini</li></ul><p>修改/etc/supervisor/supervisord.conf 最后一行处为</p><pre class="language-java"><code><span class="token punctuation">[</span>include<span class="token punctuation">]</span>
files <span class="token operator">=</span> conf<span class="token punctuation">.</span>d<span class="token comment">/*.ini    ; 
</span></code></pre><p>/etc/supervisor/conf.d/example.ini</p><pre class="language-java"><code><span class="token punctuation">[</span>program<span class="token operator">:</span>aiohttp<span class="token punctuation">]</span>
numprocs <span class="token operator">=</span> <span class="token number">4</span>
numprocs_start <span class="token operator">=</span> <span class="token number">1</span>
process_name <span class="token operator">=</span> example_<span class="token operator">%</span><span class="token punctuation">(</span>process_num<span class="token punctuation">)</span>s

<span class="token punctuation">;</span> Unix socket paths are specified by command line<span class="token punctuation">.</span>
command<span class="token operator">=</span>python3<span class="token punctuation">.</span><span class="token number">6</span> <span class="token operator">/</span>var<span class="token operator">/</span>www<span class="token operator">/</span>aio_ooad<span class="token operator">/</span>test_main<span class="token punctuation">.</span>py <span class="token operator">--</span>path<span class="token operator">=</span><span class="token operator">/</span>var<span class="token operator">/</span>www<span class="token operator">/</span>aio_ooad<span class="token operator">/</span>example_<span class="token operator">%</span><span class="token punctuation">(</span>process_num<span class="token punctuation">)</span>s<span class="token punctuation">.</span>sock <span class="token operator">--</span>port<span class="token operator">=</span><span class="token number">808</span><span class="token operator">%</span><span class="token punctuation">(</span>process_num<span class="token punctuation">)</span>s

<span class="token punctuation">;</span> We can just as easily pass TCP port numbers<span class="token operator">:</span>
<span class="token punctuation">;</span> command<span class="token operator">=</span><span class="token operator">/</span>path<span class="token operator">/</span>to<span class="token operator">/</span>aiohttp_example<span class="token punctuation">.</span>py <span class="token operator">--</span>port<span class="token operator">=</span><span class="token number">808</span><span class="token operator">%</span><span class="token punctuation">(</span>process_num<span class="token punctuation">)</span>s

user<span class="token operator">=</span>www<span class="token operator">-</span>data
autostart<span class="token operator">=</span><span class="token boolean">true</span>
autorestart<span class="token operator">=</span><span class="token boolean">true</span>
</code></pre><pre><code>numprocs = 4
numprocs_start = 1
process_name = example_%(process_num)s
</code></pre><p>一共四个进程 进程号从1到4 进程名字由进程号决定 则为example_1 example_2 example_3 example_4</p><pre><code>command=python3.6 /var/www/aio_ooad/test_main.py --path=/var/www/aio_ooad/example_%(process_num)s.sock --port=808%(process_num)s
user=www-data
</code></pre><p>后台运行此命令 也即是运行web app所在的py文件 执行用户为www-data</p><p>这里坑就比较多了</p><p>1.python模块问题
因为supervisor是由root用户运行的 所以在supervisor里面后台执行python命令也是在root用户下执行的</p><p>正如我开始所说 我一直依赖都是windows系统下进行开发的 对权限的意识不是很足</p><p>下面我们来看看一个模块安装问题
因为我是使用普通用户gzm进行安装aiohttp模块的 但是在部署之后日志显示没有安装aiohttp模块</p><p>让我们在普通用户gzm下打开python3终端 查看模块安装目录</p><p><img src="http://static.zybuluo.com/gzm1997/ho09efwz0fq58pt5r5p2olw2/image_1ch5v66t51qgklht1v4rim1ajd9.png" alt="image_1ch5v66t51qgklht1v4rim1ajd9.png-40kB"></p><p>我们会发现里面有个路径为</p><pre><code>/home/gzm/.local/lib/python3.6/site-packages
</code></pre><p>进入之后发现aiohttp正是安装在这个路径下面</p><p><img src="http://static.zybuluo.com/gzm1997/npxy5oetqeztqsxq16xr4t4b/image_1cff2pkee1quh1kbssklugl167p33.png" alt="此处输入图片的描述"></p><p>然后让我们切换为root用户 查看模块安装路径 发现没有/home/gzm/.local/lib/python3.6/site-packages 这个路径 这就解释了为什么即使我真的在gzm这个用户下安装了aiohttp等模块 但是运行supervisor还是会在日志中报错没有此模块 所以正确的方式是切换到root安装需要的模块</p><p><img src="http://static.zybuluo.com/gzm1997/clvu614mas8hh45xfdoxsgh3/image_1cff2sipucq2gtm1qid5141fvd4g.png" alt="此处输入图片的描述"></p><p>还有一个问题是</p><pre><code>--path=/var/www/aio_ooad/example_%(process_num)s.sock
</code></pre><p>意味着www-data用户需要在/var/www/aio_ooad目录下创建四个.socket文件 以支持nginx 所以/var/www/aio_ooad这个文件需要把所有权改为www-data 不然会在日志中报错permission denied</p><pre><code>sudo chown -R www-data:www-data /var/www/aio_ooad/
</code></pre><hr><h2 id="web-app所在py"><a href="#web-app所在py" aria-hidden="true" class="header-anchor">#</a> web app所在py</h2><p>test_main.py</p><pre class="language-python"><code><span class="token comment">#!/usr/bin/env python3</span>
<span class="token keyword">from</span> aiohttp_polls <span class="token keyword">import</span> main
<span class="token keyword">from</span> aiohttp <span class="token keyword">import</span> web
<span class="token keyword">import</span> argparse

parser <span class="token operator">=</span> argparse<span class="token punctuation">.</span>ArgumentParser<span class="token punctuation">(</span>description<span class="token operator">=</span><span class="token string">&quot;aiohttp server example&quot;</span><span class="token punctuation">)</span>
parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--path'</span><span class="token punctuation">)</span>
parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--port'</span><span class="token punctuation">)</span>

app <span class="token operator">=</span> main<span class="token punctuation">.</span>app
args <span class="token operator">=</span> parser<span class="token punctuation">.</span>parse_args<span class="token punctuation">(</span><span class="token punctuation">)</span>
web<span class="token punctuation">.</span>run_app<span class="token punctuation">(</span>app<span class="token punctuation">,</span> host<span class="token operator">=</span><span class="token string">&quot;0.0.0.0&quot;</span><span class="token punctuation">,</span> port<span class="token operator">=</span>args<span class="token punctuation">.</span>port<span class="token punctuation">,</span> path<span class="token operator">=</span>args<span class="token punctuation">.</span>path<span class="token punctuation">)</span>
</code></pre><hr><h2 id="nginx-supervisor重启命令"><a href="#nginx-supervisor重启命令" aria-hidden="true" class="header-anchor">#</a> nginx supervisor重启命令</h2><pre class="language-java"><code>sudo <span class="token operator">/</span>etc<span class="token operator">/</span>init<span class="token punctuation">.</span>d<span class="token operator">/</span>nginx restart
sudo supervisorctl reload
</code></pre><hr><h2 id="部署结果"><a href="#部署结果" aria-hidden="true" class="header-anchor">#</a> 部署结果</h2><p><img src="http://static.zybuluo.com/gzm1997/0k1euik0f4j5pjjkk92wn1ho/image_1ch5v927710ni1ih1il1159o10kn14.png" alt="image_1ch5v927710ni1ih1il1159o10kn14.png-89.6kB"></p></div><!----><!----></div></div></div>
    <script src="/DashBoard/assets/js/14.19f2640e.js" defer></script><script src="/DashBoard/assets/js/app.375a5640.js" defer></script>
  </body>
</html>
