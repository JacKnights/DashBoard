(window.webpackJsonp=window.webpackJsonp||[]).push([[14],{147:function(t,a,s){"use strict";s.r(a);var n=s(0),o=Object(n.a)({},function(){this.$createElement;this._self._c;return this._m(0)},[function(){var t=this,a=t.$createElement,s=t._self._c||a;return s("div",{staticClass:"content"},[s("h1",{attrs:{id:"ooad部署文档"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#ooad部署文档","aria-hidden":"true"}},[t._v("#")]),t._v(" ooad部署文档")]),s("p",[t._v("标签： 系统分析与设计")]),s("hr"),s("p",[t._v("郭柱明 15331094")]),s("hr"),s("h2",{attrs:{id:"框架和依赖"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#框架和依赖","aria-hidden":"true"}},[t._v("#")]),t._v(" 框架和依赖")]),s("p",[t._v("使用语言是python 版本为"),s("strong",[t._v("python3.6+")])]),s("p",[t._v("web后端框架 异步框架"),s("strong",[t._v("aiohttp")]),t._v("\n版本\n"),s("img",{attrs:{src:"http://static.zybuluo.com/gzm1997/aqgxm1xey0avv6dulwvlkyb7/image_1ch5t4tip1bu65fi1iin1up1r789.png",alt:"image_1ch5t4tip1bu65fi1iin1up1r789.png-4.4kB"}})]),s("p",[t._v("其他第三方依赖以及版本")]),s("p",[t._v("aiohttp_session\n"),s("img",{attrs:{src:"http://static.zybuluo.com/gzm1997/ecw0ctjio6gzlo12zn7f14sr/image_1ch5t9r2rmg1esaqge1f6i1semm.png",alt:"image_1ch5t9r2rmg1esaqge1f6i1semm.png-6.5kB"}})]),s("p",[t._v("aiohttp_cors\n"),s("img",{attrs:{src:"http://static.zybuluo.com/gzm1997/yvz876uk43ihswa50bqzdpcx/image_1ch5tlboen2h3sj1v4f1qh71kla13.png",alt:"image_1ch5tlboen2h3sj1v4f1qh71kla13.png-6.8kB"}}),t._v("\naioredis\n"),s("img",{attrs:{src:"http://static.zybuluo.com/gzm1997/31v4ugt1lpppufznyhd8jjh4/image_1ch5tloe510ma1iic7ohdnl1qhv1g.png",alt:"image_1ch5tloe510ma1iic7ohdnl1qhv1g.png-5.8kB"}}),t._v("\npasslib\n"),s("img",{attrs:{src:"http://static.zybuluo.com/gzm1997/4754pchsze7z8efy6n76tu1s/image_1ch5tm4nq144lq9b6i1amt1o1f1t.png",alt:"image_1ch5tm4nq144lq9b6i1amt1o1f1t.png-5.9kB"}}),t._v("\npyyaml\n"),s("img",{attrs:{src:"http://static.zybuluo.com/gzm1997/pip2tju6mzgdvtt6x90kfmpx/image_1ch5tmki2lude8n1qg9n001i322a.png",alt:"image_1ch5tmki2lude8n1qg9n001i322a.png-5.9kB"}}),t._v("\naiomysql\n"),s("img",{attrs:{src:"http://static.zybuluo.com/gzm1997/ixexz65anin6x3za5seg1es3/image_1ch5tni4r1h4u60c1kpvj0t1n4j2n.png",alt:"image_1ch5tni4r1h4u60c1kpvj0t1n4j2n.png-6.5kB"}}),t._v("\nmysql.connector\n"),s("img",{attrs:{src:"http://static.zybuluo.com/gzm1997/dh4590ia4lwrvc1gr6dttk4l/image_1ch5tnvds1fcf1okrepeg0sh2g34.png",alt:"image_1ch5tnvds1fcf1okrepeg0sh2g34.png-7.3kB"}}),t._v("\nsqlalchemy\n"),s("img",{attrs:{src:"http://static.zybuluo.com/gzm1997/eeoo5hblwzyutl1hnah4uejz/image_1ch5tpbhve7sq7019iqufkj4r5h.png",alt:"image_1ch5tpbhve7sq7019iqufkj4r5h.png-4.8kB"}})]),s("p",[t._v("数据库使用mysql\n"),s("img",{attrs:{src:"http://static.zybuluo.com/gzm1997/w6vk425amvol1q90661l03jh/image_1ch5tv4tt7a91ela1vs7bu92op9.png",alt:"image_1ch5tv4tt7a91ela1vs7bu92op9.png-924.3kB"}})]),s("hr"),s("h2",{attrs:{id:"部署"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#部署","aria-hidden":"true"}},[t._v("#")]),t._v(" 部署")]),s("p",[t._v("为什么选择nginx+supervisor这样的组合来部署 因为")]),s("p",[t._v("优点")]),s("ul",[s("li",[t._v("nginx是一个完美的前端服务器 可以防止基于畸形的http协议的攻击等等")]),s("li",[t._v("使用nginx运行几个aiohttp实例可以使用CPU多核")]),s("li",[t._v("nginx对static静态文件的支持比aiohttp的内置的静态文件支持更快")]),s("li",[t._v("supervisor主要是为了系统崩溃或者重启之后重新运行web app实例 怎么kill也kill不掉")])]),s("p",[t._v("缺点")]),s("ul",[s("li",[t._v("配置比其他组合方式麻烦一点")])]),s("p",[s("a",{attrs:{href:"http://static.zybuluo.com/gzm1997/aqgxm1xey0avv6dulwvlkyb7/image_1ch5t4tip1bu65fi1iin1up1r789.png",target:"_blank",rel:"noopener noreferrer"}},[t._v("参考链接")])]),s("p",[t._v("由于选择使用nginx+superviosr的组合方式部署aiohttp 所以要先下载nginx和supervisor 这个没什么问题 自行谷歌即可 但是要注意点")]),s("blockquote",[s("p",[t._v("因为aiohttp是只可以支持python3.5.3+的 但是好巧不巧ubuntu16.04的自带python版本是python3.5.2 这下有点蛋疼 我给的建议是保留python3.5 另外安装python3.6")]),s("p",[t._v("因为ubuntu系统以及很多像sublime等软件都是依赖py2或者py3.5的 一旦卸载或者修改了/use/bin/python的链接\n会导致一系列版本不兼容的问题 我试过最严重的是卸载了python3.5 并且修改默认python版本为3.6 系统崩溃\n折腾了很久最后只能重装系统")]),s("p",[t._v("为什么我要说这个呢 因为supervisor依赖于ubuntu的py2的\n所以最好不要卸载任何版本python和修改系统默认的python版本 最好就另行安装python3.6 终端中使用python3.6调用即可")])]),s("p",[t._v("项目代码放置于/var/www/aio_ooad下\n"),s("img",{attrs:{src:"http://static.zybuluo.com/gzm1997/ecw0ctjio6gzlo12zn7f14sr/image_1ch5t9r2rmg1esaqge1f6i1semm.png",alt:"image_1cff1giub10gmo07k6b16gjv339.png-71.6kB"}})]),s("hr"),s("h2",{attrs:{id:"nginx配置"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#nginx配置","aria-hidden":"true"}},[t._v("#")]),t._v(" nginx配置")]),s("ul",[s("li",[t._v("nginx配置文件 /etc/nginx/nginx.conf")]),s("li",[t._v("nginx日志文件")]),s("li",[t._v("/var/log/nginx/access.log")]),s("li",[t._v("/var/log/nginx/error.log")])]),s("p",[t._v("/etc/nginx/nginx.conf")]),s("pre",{pre:!0,attrs:{class:"language-java"}},[s("code",[t._v("http "),s("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  server "),s("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    listen "),s("span",{attrs:{class:"token number"}},[t._v("80")]),s("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    client_max_body_size "),s("span",{attrs:{class:"token number"}},[t._v("4")]),t._v("G"),s("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    server_name localhost"),s("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    location "),s("span",{attrs:{class:"token operator"}},[t._v("/")]),t._v(" "),s("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      proxy_set_header Host $http_host"),s("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n      proxy_set_header X"),s("span",{attrs:{class:"token operator"}},[t._v("-")]),t._v("Forwarded"),s("span",{attrs:{class:"token operator"}},[t._v("-")]),t._v("For $proxy_add_x_forwarded_for"),s("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n      proxy_redirect off"),s("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n      proxy_buffering off"),s("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n      proxy_pass http"),s("span",{attrs:{class:"token operator"}},[t._v(":")]),s("span",{attrs:{class:"token operator"}},[t._v("/")]),s("span",{attrs:{class:"token operator"}},[t._v("/")]),t._v("aiohttp"),s("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n    location "),s("span",{attrs:{class:"token operator"}},[t._v("/")]),s("span",{attrs:{class:"token keyword"}},[t._v("static")]),t._v(" "),s("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      # path "),s("span",{attrs:{class:"token keyword"}},[t._v("for")]),t._v(" "),s("span",{attrs:{class:"token keyword"}},[t._v("static")]),t._v(" files\n      root "),s("span",{attrs:{class:"token operator"}},[t._v("/")]),t._v("var"),s("span",{attrs:{class:"token operator"}},[t._v("/")]),t._v("www"),s("span",{attrs:{class:"token operator"}},[t._v("/")]),t._v("aio_ooad"),s("span",{attrs:{class:"token operator"}},[t._v("/")]),s("span",{attrs:{class:"token keyword"}},[t._v("static")]),s("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n  "),s("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  upstream aiohttp "),s("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    # fail_timeout"),s("span",{attrs:{class:"token operator"}},[t._v("=")]),s("span",{attrs:{class:"token number"}},[t._v("0")]),t._v(" means we always retry an upstream even "),s("span",{attrs:{class:"token keyword"}},[t._v("if")]),t._v(" it failed\n    # to "),s("span",{attrs:{class:"token keyword"}},[t._v("return")]),t._v(" a good HTTP response\n\n    # Unix domain servers\n    server unix"),s("span",{attrs:{class:"token operator"}},[t._v(":")]),s("span",{attrs:{class:"token operator"}},[t._v("/")]),t._v("var"),s("span",{attrs:{class:"token operator"}},[t._v("/")]),t._v("www"),s("span",{attrs:{class:"token operator"}},[t._v("/")]),t._v("aio_ooad"),s("span",{attrs:{class:"token operator"}},[t._v("/")]),t._v("example_1"),s("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("sock fail_timeout"),s("span",{attrs:{class:"token operator"}},[t._v("=")]),s("span",{attrs:{class:"token number"}},[t._v("0")]),s("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    server unix"),s("span",{attrs:{class:"token operator"}},[t._v(":")]),s("span",{attrs:{class:"token operator"}},[t._v("/")]),t._v("var"),s("span",{attrs:{class:"token operator"}},[t._v("/")]),t._v("www"),s("span",{attrs:{class:"token operator"}},[t._v("/")]),t._v("aio_ooad"),s("span",{attrs:{class:"token operator"}},[t._v("/")]),t._v("example_2"),s("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("sock fail_timeout"),s("span",{attrs:{class:"token operator"}},[t._v("=")]),s("span",{attrs:{class:"token number"}},[t._v("0")]),s("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    server unix"),s("span",{attrs:{class:"token operator"}},[t._v(":")]),s("span",{attrs:{class:"token operator"}},[t._v("/")]),t._v("var"),s("span",{attrs:{class:"token operator"}},[t._v("/")]),t._v("www"),s("span",{attrs:{class:"token operator"}},[t._v("/")]),t._v("aio_ooad"),s("span",{attrs:{class:"token operator"}},[t._v("/")]),t._v("example_3"),s("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("sock fail_timeout"),s("span",{attrs:{class:"token operator"}},[t._v("=")]),s("span",{attrs:{class:"token number"}},[t._v("0")]),s("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    server unix"),s("span",{attrs:{class:"token operator"}},[t._v(":")]),s("span",{attrs:{class:"token operator"}},[t._v("/")]),t._v("var"),s("span",{attrs:{class:"token operator"}},[t._v("/")]),t._v("www"),s("span",{attrs:{class:"token operator"}},[t._v("/")]),t._v("aio_ooad"),s("span",{attrs:{class:"token operator"}},[t._v("/")]),t._v("example_4"),s("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("sock fail_timeout"),s("span",{attrs:{class:"token operator"}},[t._v("=")]),s("span",{attrs:{class:"token number"}},[t._v("0")]),s("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    # Unix domain sockets are used in "),s("span",{attrs:{class:"token keyword"}},[t._v("this")]),t._v(" example due to their high performance"),s("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    # but TCP"),s("span",{attrs:{class:"token operator"}},[t._v("/")]),t._v("IP sockets could be used instead"),s("span",{attrs:{class:"token operator"}},[t._v(":")]),t._v("\n    # server "),s("span",{attrs:{class:"token number"}},[t._v("127.0")]),s("span",{attrs:{class:"token number"}},[t._v(".0")]),s("span",{attrs:{class:"token number"}},[t._v(".1")]),s("span",{attrs:{class:"token operator"}},[t._v(":")]),s("span",{attrs:{class:"token number"}},[t._v("8081")]),t._v(" fail_timeout"),s("span",{attrs:{class:"token operator"}},[t._v("=")]),s("span",{attrs:{class:"token number"}},[t._v("0")]),s("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    # server "),s("span",{attrs:{class:"token number"}},[t._v("127.0")]),s("span",{attrs:{class:"token number"}},[t._v(".0")]),s("span",{attrs:{class:"token number"}},[t._v(".1")]),s("span",{attrs:{class:"token operator"}},[t._v(":")]),s("span",{attrs:{class:"token number"}},[t._v("8082")]),t._v(" fail_timeout"),s("span",{attrs:{class:"token operator"}},[t._v("=")]),s("span",{attrs:{class:"token number"}},[t._v("0")]),s("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    # server "),s("span",{attrs:{class:"token number"}},[t._v("127.0")]),s("span",{attrs:{class:"token number"}},[t._v(".0")]),s("span",{attrs:{class:"token number"}},[t._v(".1")]),s("span",{attrs:{class:"token operator"}},[t._v(":")]),s("span",{attrs:{class:"token number"}},[t._v("8083")]),t._v(" fail_timeout"),s("span",{attrs:{class:"token operator"}},[t._v("=")]),s("span",{attrs:{class:"token number"}},[t._v("0")]),s("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    # server "),s("span",{attrs:{class:"token number"}},[t._v("127.0")]),s("span",{attrs:{class:"token number"}},[t._v(".0")]),s("span",{attrs:{class:"token number"}},[t._v(".1")]),s("span",{attrs:{class:"token operator"}},[t._v(":")]),s("span",{attrs:{class:"token number"}},[t._v("8084")]),t._v(" fail_timeout"),s("span",{attrs:{class:"token operator"}},[t._v("=")]),s("span",{attrs:{class:"token number"}},[t._v("0")]),s("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),s("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),s("p",[t._v("上面大部分内容都是常规的")]),s("p",[t._v("指明静态文件路径 nginx提供静态文件的支持是很快的 这是选择nginx部署的原因之一")]),s("pre",{pre:!0,attrs:{class:"language-java"}},[s("code",[t._v("    location "),s("span",{attrs:{class:"token operator"}},[t._v("/")]),s("span",{attrs:{class:"token keyword"}},[t._v("static")]),t._v(" "),s("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      # path "),s("span",{attrs:{class:"token keyword"}},[t._v("for")]),t._v(" "),s("span",{attrs:{class:"token keyword"}},[t._v("static")]),t._v(" files\n      root "),s("span",{attrs:{class:"token operator"}},[t._v("/")]),t._v("var"),s("span",{attrs:{class:"token operator"}},[t._v("/")]),t._v("www"),s("span",{attrs:{class:"token operator"}},[t._v("/")]),t._v("aio_ooad"),s("span",{attrs:{class:"token operator"}},[t._v("/")]),s("span",{attrs:{class:"token keyword"}},[t._v("static")]),s("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),s("p",[t._v("选择使用unix domian sockets文件的方式设置upstream 下面的注释也说到也可以使用TCP/IP sockets的方式 但是unix domain socket效果更好 一共配置了四个sockets文件 意味着后台一共有四个web app实例可以供nginx轮询选择")]),s("pre",{pre:!0,attrs:{class:"language-java"}},[s("code",[t._v("  upstream aiohttp "),s("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    # fail_timeout"),s("span",{attrs:{class:"token operator"}},[t._v("=")]),s("span",{attrs:{class:"token number"}},[t._v("0")]),t._v(" means we always retry an upstream even "),s("span",{attrs:{class:"token keyword"}},[t._v("if")]),t._v(" it failed\n    # to "),s("span",{attrs:{class:"token keyword"}},[t._v("return")]),t._v(" a good HTTP response\n\n    # Unix domain servers\n    server unix"),s("span",{attrs:{class:"token operator"}},[t._v(":")]),s("span",{attrs:{class:"token operator"}},[t._v("/")]),t._v("var"),s("span",{attrs:{class:"token operator"}},[t._v("/")]),t._v("www"),s("span",{attrs:{class:"token operator"}},[t._v("/")]),t._v("aio_ooad"),s("span",{attrs:{class:"token operator"}},[t._v("/")]),t._v("example_1"),s("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("sock fail_timeout"),s("span",{attrs:{class:"token operator"}},[t._v("=")]),s("span",{attrs:{class:"token number"}},[t._v("0")]),s("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    server unix"),s("span",{attrs:{class:"token operator"}},[t._v(":")]),s("span",{attrs:{class:"token operator"}},[t._v("/")]),t._v("var"),s("span",{attrs:{class:"token operator"}},[t._v("/")]),t._v("www"),s("span",{attrs:{class:"token operator"}},[t._v("/")]),t._v("aio_ooad"),s("span",{attrs:{class:"token operator"}},[t._v("/")]),t._v("example_2"),s("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("sock fail_timeout"),s("span",{attrs:{class:"token operator"}},[t._v("=")]),s("span",{attrs:{class:"token number"}},[t._v("0")]),s("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    server unix"),s("span",{attrs:{class:"token operator"}},[t._v(":")]),s("span",{attrs:{class:"token operator"}},[t._v("/")]),t._v("var"),s("span",{attrs:{class:"token operator"}},[t._v("/")]),t._v("www"),s("span",{attrs:{class:"token operator"}},[t._v("/")]),t._v("aio_ooad"),s("span",{attrs:{class:"token operator"}},[t._v("/")]),t._v("example_3"),s("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("sock fail_timeout"),s("span",{attrs:{class:"token operator"}},[t._v("=")]),s("span",{attrs:{class:"token number"}},[t._v("0")]),s("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    server unix"),s("span",{attrs:{class:"token operator"}},[t._v(":")]),s("span",{attrs:{class:"token operator"}},[t._v("/")]),t._v("var"),s("span",{attrs:{class:"token operator"}},[t._v("/")]),t._v("www"),s("span",{attrs:{class:"token operator"}},[t._v("/")]),t._v("aio_ooad"),s("span",{attrs:{class:"token operator"}},[t._v("/")]),t._v("example_4"),s("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("sock fail_timeout"),s("span",{attrs:{class:"token operator"}},[t._v("=")]),s("span",{attrs:{class:"token number"}},[t._v("0")]),s("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    # Unix domain sockets are used in "),s("span",{attrs:{class:"token keyword"}},[t._v("this")]),t._v(" example due to their high performance"),s("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    # but TCP"),s("span",{attrs:{class:"token operator"}},[t._v("/")]),t._v("IP sockets could be used instead"),s("span",{attrs:{class:"token operator"}},[t._v(":")]),t._v("\n    # server "),s("span",{attrs:{class:"token number"}},[t._v("127.0")]),s("span",{attrs:{class:"token number"}},[t._v(".0")]),s("span",{attrs:{class:"token number"}},[t._v(".1")]),s("span",{attrs:{class:"token operator"}},[t._v(":")]),s("span",{attrs:{class:"token number"}},[t._v("8081")]),t._v(" fail_timeout"),s("span",{attrs:{class:"token operator"}},[t._v("=")]),s("span",{attrs:{class:"token number"}},[t._v("0")]),s("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    # server "),s("span",{attrs:{class:"token number"}},[t._v("127.0")]),s("span",{attrs:{class:"token number"}},[t._v(".0")]),s("span",{attrs:{class:"token number"}},[t._v(".1")]),s("span",{attrs:{class:"token operator"}},[t._v(":")]),s("span",{attrs:{class:"token number"}},[t._v("8082")]),t._v(" fail_timeout"),s("span",{attrs:{class:"token operator"}},[t._v("=")]),s("span",{attrs:{class:"token number"}},[t._v("0")]),s("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    # server "),s("span",{attrs:{class:"token number"}},[t._v("127.0")]),s("span",{attrs:{class:"token number"}},[t._v(".0")]),s("span",{attrs:{class:"token number"}},[t._v(".1")]),s("span",{attrs:{class:"token operator"}},[t._v(":")]),s("span",{attrs:{class:"token number"}},[t._v("8083")]),t._v(" fail_timeout"),s("span",{attrs:{class:"token operator"}},[t._v("=")]),s("span",{attrs:{class:"token number"}},[t._v("0")]),s("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    # server "),s("span",{attrs:{class:"token number"}},[t._v("127.0")]),s("span",{attrs:{class:"token number"}},[t._v(".0")]),s("span",{attrs:{class:"token number"}},[t._v(".1")]),s("span",{attrs:{class:"token operator"}},[t._v(":")]),s("span",{attrs:{class:"token number"}},[t._v("8084")]),t._v(" fail_timeout"),s("span",{attrs:{class:"token operator"}},[t._v("=")]),s("span",{attrs:{class:"token number"}},[t._v("0")]),s("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),s("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),s("hr"),s("h2",{attrs:{id:"supervisor配置"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#supervisor配置","aria-hidden":"true"}},[t._v("#")]),t._v(" supervisor配置")]),s("ul",[s("li",[t._v("supervisor默认配置文件 /etc/supervisor/supervisord.conf")]),s("li",[t._v("部署项目的配置文件 /etc/supervisor/conf.d/example.ini")])]),s("p",[t._v("修改/etc/supervisor/supervisord.conf 最后一行处为")]),s("pre",{pre:!0,attrs:{class:"language-java"}},[s("code",[s("span",{attrs:{class:"token punctuation"}},[t._v("[")]),t._v("include"),s("span",{attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\nfiles "),s("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" conf"),s("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("d"),s("span",{attrs:{class:"token comment"}},[t._v("/*.ini    ; \n")])])]),s("p",[t._v("/etc/supervisor/conf.d/example.ini")]),s("pre",{pre:!0,attrs:{class:"language-java"}},[s("code",[s("span",{attrs:{class:"token punctuation"}},[t._v("[")]),t._v("program"),s("span",{attrs:{class:"token operator"}},[t._v(":")]),t._v("aiohttp"),s("span",{attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\nnumprocs "),s("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{attrs:{class:"token number"}},[t._v("4")]),t._v("\nnumprocs_start "),s("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{attrs:{class:"token number"}},[t._v("1")]),t._v("\nprocess_name "),s("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" example_"),s("span",{attrs:{class:"token operator"}},[t._v("%")]),s("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("process_num"),s("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("s\n\n"),s("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" Unix socket paths are specified by command line"),s("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\ncommand"),s("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v("python3"),s("span",{attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{attrs:{class:"token number"}},[t._v("6")]),t._v(" "),s("span",{attrs:{class:"token operator"}},[t._v("/")]),t._v("var"),s("span",{attrs:{class:"token operator"}},[t._v("/")]),t._v("www"),s("span",{attrs:{class:"token operator"}},[t._v("/")]),t._v("aio_ooad"),s("span",{attrs:{class:"token operator"}},[t._v("/")]),t._v("test_main"),s("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("py "),s("span",{attrs:{class:"token operator"}},[t._v("--")]),t._v("path"),s("span",{attrs:{class:"token operator"}},[t._v("=")]),s("span",{attrs:{class:"token operator"}},[t._v("/")]),t._v("var"),s("span",{attrs:{class:"token operator"}},[t._v("/")]),t._v("www"),s("span",{attrs:{class:"token operator"}},[t._v("/")]),t._v("aio_ooad"),s("span",{attrs:{class:"token operator"}},[t._v("/")]),t._v("example_"),s("span",{attrs:{class:"token operator"}},[t._v("%")]),s("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("process_num"),s("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("s"),s("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("sock "),s("span",{attrs:{class:"token operator"}},[t._v("--")]),t._v("port"),s("span",{attrs:{class:"token operator"}},[t._v("=")]),s("span",{attrs:{class:"token number"}},[t._v("808")]),s("span",{attrs:{class:"token operator"}},[t._v("%")]),s("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("process_num"),s("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("s\n\n"),s("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" We can just as easily pass TCP port numbers"),s("span",{attrs:{class:"token operator"}},[t._v(":")]),t._v("\n"),s("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" command"),s("span",{attrs:{class:"token operator"}},[t._v("=")]),s("span",{attrs:{class:"token operator"}},[t._v("/")]),t._v("path"),s("span",{attrs:{class:"token operator"}},[t._v("/")]),t._v("to"),s("span",{attrs:{class:"token operator"}},[t._v("/")]),t._v("aiohttp_example"),s("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("py "),s("span",{attrs:{class:"token operator"}},[t._v("--")]),t._v("port"),s("span",{attrs:{class:"token operator"}},[t._v("=")]),s("span",{attrs:{class:"token number"}},[t._v("808")]),s("span",{attrs:{class:"token operator"}},[t._v("%")]),s("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("process_num"),s("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("s\n\nuser"),s("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v("www"),s("span",{attrs:{class:"token operator"}},[t._v("-")]),t._v("data\nautostart"),s("span",{attrs:{class:"token operator"}},[t._v("=")]),s("span",{attrs:{class:"token boolean"}},[t._v("true")]),t._v("\nautorestart"),s("span",{attrs:{class:"token operator"}},[t._v("=")]),s("span",{attrs:{class:"token boolean"}},[t._v("true")]),t._v("\n")])]),s("pre",[s("code",[t._v("numprocs = 4\nnumprocs_start = 1\nprocess_name = example_%(process_num)s\n")])]),s("p",[t._v("一共四个进程 进程号从1到4 进程名字由进程号决定 则为example_1 example_2 example_3 example_4")]),s("pre",[s("code",[t._v("command=python3.6 /var/www/aio_ooad/test_main.py --path=/var/www/aio_ooad/example_%(process_num)s.sock --port=808%(process_num)s\nuser=www-data\n")])]),s("p",[t._v("后台运行此命令 也即是运行web app所在的py文件 执行用户为www-data")]),s("p",[t._v("这里坑就比较多了")]),s("p",[t._v("1.python模块问题\n因为supervisor是由root用户运行的 所以在supervisor里面后台执行python命令也是在root用户下执行的")]),s("p",[t._v("正如我开始所说 我一直依赖都是windows系统下进行开发的 对权限的意识不是很足")]),s("p",[t._v("下面我们来看看一个模块安装问题\n因为我是使用普通用户gzm进行安装aiohttp模块的 但是在部署之后日志显示没有安装aiohttp模块")]),s("p",[t._v("让我们在普通用户gzm下打开python3终端 查看模块安装目录")]),s("p",[s("img",{attrs:{src:"http://static.zybuluo.com/gzm1997/ho09efwz0fq58pt5r5p2olw2/image_1ch5v66t51qgklht1v4rim1ajd9.png",alt:"image_1ch5v66t51qgklht1v4rim1ajd9.png-40kB"}})]),s("p",[t._v("我们会发现里面有个路径为")]),s("pre",[s("code",[t._v("/home/gzm/.local/lib/python3.6/site-packages\n")])]),s("p",[t._v("进入之后发现aiohttp正是安装在这个路径下面")]),s("p",[s("img",{attrs:{src:"http://static.zybuluo.com/gzm1997/npxy5oetqeztqsxq16xr4t4b/image_1cff2pkee1quh1kbssklugl167p33.png",alt:"此处输入图片的描述"}})]),s("p",[t._v("然后让我们切换为root用户 查看模块安装路径 发现没有/home/gzm/.local/lib/python3.6/site-packages 这个路径 这就解释了为什么即使我真的在gzm这个用户下安装了aiohttp等模块 但是运行supervisor还是会在日志中报错没有此模块 所以正确的方式是切换到root安装需要的模块")]),s("p",[s("img",{attrs:{src:"http://static.zybuluo.com/gzm1997/clvu614mas8hh45xfdoxsgh3/image_1cff2sipucq2gtm1qid5141fvd4g.png",alt:"此处输入图片的描述"}})]),s("p",[t._v("还有一个问题是")]),s("pre",[s("code",[t._v("--path=/var/www/aio_ooad/example_%(process_num)s.sock\n")])]),s("p",[t._v("意味着www-data用户需要在/var/www/aio_ooad目录下创建四个.socket文件 以支持nginx 所以/var/www/aio_ooad这个文件需要把所有权改为www-data 不然会在日志中报错permission denied")]),s("pre",[s("code",[t._v("sudo chown -R www-data:www-data /var/www/aio_ooad/\n")])]),s("hr"),s("h2",{attrs:{id:"web-app所在py"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#web-app所在py","aria-hidden":"true"}},[t._v("#")]),t._v(" web app所在py")]),s("p",[t._v("test_main.py")]),s("pre",{pre:!0,attrs:{class:"language-python"}},[s("code",[s("span",{attrs:{class:"token comment"}},[t._v("#!/usr/bin/env python3")]),t._v("\n"),s("span",{attrs:{class:"token keyword"}},[t._v("from")]),t._v(" aiohttp_polls "),s("span",{attrs:{class:"token keyword"}},[t._v("import")]),t._v(" main\n"),s("span",{attrs:{class:"token keyword"}},[t._v("from")]),t._v(" aiohttp "),s("span",{attrs:{class:"token keyword"}},[t._v("import")]),t._v(" web\n"),s("span",{attrs:{class:"token keyword"}},[t._v("import")]),t._v(" argparse\n\nparser "),s("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" argparse"),s("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("ArgumentParser"),s("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("description"),s("span",{attrs:{class:"token operator"}},[t._v("=")]),s("span",{attrs:{class:"token string"}},[t._v('"aiohttp server example"')]),s("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\nparser"),s("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("add_argument"),s("span",{attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{attrs:{class:"token string"}},[t._v("'--path'")]),s("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\nparser"),s("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("add_argument"),s("span",{attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{attrs:{class:"token string"}},[t._v("'--port'")]),s("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\napp "),s("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" main"),s("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("app\nargs "),s("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" parser"),s("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("parse_args"),s("span",{attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\nweb"),s("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("run_app"),s("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("app"),s("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" host"),s("span",{attrs:{class:"token operator"}},[t._v("=")]),s("span",{attrs:{class:"token string"}},[t._v('"0.0.0.0"')]),s("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" port"),s("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v("args"),s("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("port"),s("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" path"),s("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v("args"),s("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("path"),s("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])]),s("hr"),s("h2",{attrs:{id:"nginx-supervisor重启命令"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#nginx-supervisor重启命令","aria-hidden":"true"}},[t._v("#")]),t._v(" nginx supervisor重启命令")]),s("pre",{pre:!0,attrs:{class:"language-java"}},[s("code",[t._v("sudo "),s("span",{attrs:{class:"token operator"}},[t._v("/")]),t._v("etc"),s("span",{attrs:{class:"token operator"}},[t._v("/")]),t._v("init"),s("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("d"),s("span",{attrs:{class:"token operator"}},[t._v("/")]),t._v("nginx restart\nsudo supervisorctl reload\n")])]),s("hr"),s("h2",{attrs:{id:"部署结果"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#部署结果","aria-hidden":"true"}},[t._v("#")]),t._v(" 部署结果")]),s("p",[s("img",{attrs:{src:"http://static.zybuluo.com/gzm1997/0k1euik0f4j5pjjkk92wn1ho/image_1ch5v927710ni1ih1il1159o10kn14.png",alt:"image_1ch5v927710ni1ih1il1159o10kn14.png-89.6kB"}})])])}],!1,null,null,null);a.default=o.exports}}]);